# https 加密过程

涉及到 3 个核心概念：

- 数字证书
  - 证书中包含服务器的非对称加密的公钥
- 非对称加密
  - 客户端用服务端的公钥加密传输对称加密的密钥
- 对称加密
  - 加密传输数据

步骤如下：

- 客户端发起 https 连接
- 服务器发送 ssl 证书，证书中包括服务器公钥、域名等信息
- 客户端验证证书有效性
- 客户端生成随机的对称密钥，用服务器的公钥加密后发送给服务器
- 服务器用私钥解密获取对称密钥
- 开始加密传输（对称加密）

# 在浏览器中输入地址到页面渲染，发生了什么

- url 解析
  - 地址解析：解析 url 协议，域名，端口，路径
  - HSTS 检查： 如果域名在 HSTS 列表中，强制使用 https
- dns 解析
  - 获取到服务器地址
- tcp 连接
  - tcp 三次握手
  - tls 握手（https）
- http 请求
- 服务器处理
- 响应接收
- 浏览器渲染

# http 状态码

- 1XX 信息响应
- 2XX 成功
- 3XX 重定向
- 4XX 客户端错误
- 5XX 服务端错误

# http 缓存

- 浏览器发起请求时，先判断强缓存是否有效，有效就用缓存
- 如果无效，向服务器发起请求，服务器检查协商缓存是否有效，如果有效，返回 304 not modified，浏览器使用本地缓存
- 如果协商缓存无效，返回 200 和新资源

## 强缓存

- Expires 强缓存使用 Expires 头判断
  - 存在的问题是，服务端和客户端时间不一致导致判断错误
- Cache-Control 这个字段优先级比 Expires 高，他有多种设置：
  - max-age 缓存最大有效时间（秒）
  - public 响应可被任何中间节点缓存
  - private 响应只能被浏览器缓存
  - no-cache 需要协商缓存验证
  - no-store 禁止任何缓存
  - must-revalidate 必须验证过期资源

## 协商缓存

- Last-Modified / If-Modified-Since
  - 基于文件修改时间
  - 缺点：
    - 只精确到秒级
    - 文件内容不变，但修改时间变化会失效
    - CDN 回源可能导致时间变化
- Etag / If-None-Match
  - 基于文件内容的 hash 值
  - 更精确
  - 但是消耗服务器资源
  - 优先级比 Last-Modified 高
